{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <h1>Today's Recap</h1>
        <p>{{ current_date.strftime('%A, %B %d, %Y') }}</p>
    </header>

    <!-- Phase 3: Smart Daily Recap -->
    <div class="recap-card">
        <div class="recap-header">
            <h2>üß† Daily Intelligence</h2>
            <button onclick="refreshRecap()" class="btn-icon">üîÑ</button>
        </div>
        <div class="recap-content">
            <p>{{ daily_recap.summary }}</p>
            <div class="recap-metrics">
                <div class="metric">
                    <span class="metric-value">{{ daily_recap.completed_count }}</span>
                    <span class="metric-label">Completed</span>
                </div>
                <div class="metric">
                    <span class="metric-value">{{ daily_recap.overdue_count }}</span>
                    <span class="metric-label">Overdue</span>
                </div>
                <div class="metric">
                    <span class="metric-value">{{ daily_recap.notes_count }}</span>
                    <span class="metric-label">New Ideas</span>
                </div>
                <div class="metric">
                    <span class="metric-value">{{ daily_recap.productivity_score }}%</span>
                    <span class="metric-label">Productivity</span>
                </div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Completed Today</h3>
            <div class="stat-number">{{ completed_today }}</div>
        </div>
        <div class="stat-card">
            <h3>Pending Tasks</h3>
            <div class="stat-number">{{ today_tasks|length }}</div>
        </div>
        <div class="stat-card">
            <h3>Productivity</h3>
            <div class="stat-number">
                {% if completed_today + today_tasks|length > 0 %}
                    {{ (completed_today / (completed_today + today_tasks|length) * 100)|int }}%
                {% else %}
                    0%
                {% endif %}
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <section class="dashboard-section">
            <h2>Today's Tasks</h2>
            <div class="task-list">
                {% for task in today_tasks %}
                <div class="task-item {% if task.completed %}completed{% endif %}">
                    <input type="checkbox" {% if task.completed %}checked{% endif %} 
                           onchange="toggleTaskCompletion({{ task.id }})">
                    <span class="task-title">{{ task.title }}</span>
                    {% if task.due_date %}
                    <span class="task-due">{{ task.due_date.strftime('%H:%M') }}</span>
                    {% endif %}
                </div>
                {% else %}
                <p class="empty-state">No tasks for today! üéâ</p>
                {% endfor %}
            </div>
            <a href="{{ url_for('tasks') }}" class="btn-secondary">View All Tasks</a>
        </section>

        <section class="dashboard-section">
            <h2>Recent Notes</h2>
            <div class="notes-preview">
                {% for note in recent_notes %}
                <div class="note-preview">
                    <p>{{ note.content[:100] }}{% if note.content|length > 100 %}...{% endif %}</p>
                    <small>{{ note.updated_at.strftime('%H:%M') }}</small>
                </div>
                {% else %}
                <p class="empty-state">No notes yet üìù</p>
                {% endfor %}
            </div>
            <a href="{{ url_for('notes') }}" class="btn-secondary">View All Notes</a>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshRecap() {
    fetch('/api/daily-recap')
        .then(response => response.json())
        .then(recap => {
            // Update recap content dynamically
            document.querySelector('.recap-content p').textContent = recap.summary;
            const metrics = document.querySelectorAll('.metric-value');
            metrics[0].textContent = recap.completed_count;
            metrics[1].textContent = recap.overdue_count;
            metrics[2].textContent = recap.notes_count;
            metrics[3].textContent = recap.productivity_score + '%';
        });
}

// Task completion function
async function toggleTaskCompletion(taskId) {
    try {
        const taskElement = document.querySelector(`[onchange="toggleTaskCompletion(${taskId})"]`);
        const isCompleted = taskElement.checked;
        
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ completed: isCompleted })
        });
        
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Error updating task:', error);
    }
}
</script>
{% endblock %}